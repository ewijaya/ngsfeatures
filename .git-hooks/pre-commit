#!/bin/bash
# Pre-commit hook for NGSFeatures
# This is a traditional git hook (alternative to pre-commit framework)
#
# Installation:
#   cp .git-hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use a symlink:
#   ln -sf ../../.git-hooks/pre-commit .git/hooks/pre-commit

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}Running pre-commit checks...${NC}"

# ============================================================================
# Check for large files
# ============================================================================
echo -e "${YELLOW}Checking for large files...${NC}"
MAX_FILE_SIZE=1000 # KB
large_files=$(git diff --cached --name-only --diff-filter=ACM | \
  while read file; do
    if [ -f "$file" ]; then
      size=$(du -k "$file" | cut -f1)
      if [ "$size" -gt "$MAX_FILE_SIZE" ]; then
        echo "$file ($size KB)"
      fi
    fi
  done)

if [ -n "$large_files" ]; then
  echo -e "${RED}Error: Large files detected (>$MAX_FILE_SIZE KB):${NC}"
  echo "$large_files"
  echo "Consider using Git LFS or excluding these files."
  exit 1
fi

# ============================================================================
# Format C++ files with clang-format
# ============================================================================
if command -v clang-format &> /dev/null; then
  echo -e "${YELLOW}Formatting C++ files...${NC}"
  cpp_files=$(git diff --cached --name-only --diff-filter=ACM | \
    grep -E '\.(cc|cpp|h|hh|hpp)$' | \
    grep -v -E '(test/|try/)' || true)

  if [ -n "$cpp_files" ]; then
    echo "$cpp_files" | xargs clang-format -i
    echo "$cpp_files" | xargs git add
    echo -e "${GREEN}✓ C++ files formatted${NC}"
  fi
else
  echo -e "${YELLOW}⚠ clang-format not found, skipping C++ formatting${NC}"
fi

# ============================================================================
# Format Python files with ruff
# ============================================================================
if command -v ruff &> /dev/null; then
  echo -e "${YELLOW}Formatting Python files...${NC}"
  python_files=$(git diff --cached --name-only --diff-filter=ACM | \
    grep '\.py$' || true)

  if [ -n "$python_files" ]; then
    # Format with ruff
    echo "$python_files" | xargs ruff format

    # Lint and fix with ruff
    echo "$python_files" | xargs ruff check --fix || true

    # Re-add formatted files
    echo "$python_files" | xargs git add
    echo -e "${GREEN}✓ Python files formatted and linted${NC}"
  fi
else
  echo -e "${YELLOW}⚠ ruff not found, skipping Python formatting${NC}"
fi

# ============================================================================
# Check for Python type errors with mypy
# ============================================================================
if command -v mypy &> /dev/null; then
  echo -e "${YELLOW}Checking Python types...${NC}"
  python_files=$(git diff --cached --name-only --diff-filter=ACM | \
    grep '\.py$' | grep -v '^tests/' || true)

  if [ -n "$python_files" ]; then
    if echo "$python_files" | xargs mypy --ignore-missing-imports --show-error-codes; then
      echo -e "${GREEN}✓ Python type checking passed${NC}"
    else
      echo -e "${RED}⚠ Type checking warnings found (not blocking)${NC}"
      # Don't block on type errors for now
    fi
  fi
else
  echo -e "${YELLOW}⚠ mypy not found, skipping type checking${NC}"
fi

# ============================================================================
# Check for trailing whitespace
# ============================================================================
echo -e "${YELLOW}Checking for trailing whitespace...${NC}"
files_with_whitespace=$(git diff --cached --name-only --diff-filter=ACM | \
  while read file; do
    if [ -f "$file" ] && grep -q '[[:space:]]$' "$file"; then
      echo "$file"
    fi
  done)

if [ -n "$files_with_whitespace" ]; then
  echo -e "${YELLOW}Warning: Files with trailing whitespace:${NC}"
  echo "$files_with_whitespace"
  # Auto-fix if sed is available
  if command -v sed &> /dev/null; then
    echo "$files_with_whitespace" | while read file; do
      sed -i 's/[[:space:]]*$//' "$file"
      git add "$file"
    done
    echo -e "${GREEN}✓ Trailing whitespace removed${NC}"
  fi
fi

# ============================================================================
# Check for merge conflict markers
# ============================================================================
echo -e "${YELLOW}Checking for merge conflicts...${NC}"
if git diff --cached --name-only --diff-filter=ACM | xargs grep -l '^<<<<<<< \|^=======$\|^>>>>>>> ' 2>/dev/null; then
  echo -e "${RED}Error: Merge conflict markers found!${NC}"
  exit 1
fi

# ============================================================================
# Check for common C++ issues
# ============================================================================
echo -e "${YELLOW}Checking for unsafe C++ patterns...${NC}"
cpp_files=$(git diff --cached --name-only --diff-filter=ACM | \
  grep -E '\.(cc|cpp)$' || true)

if [ -n "$cpp_files" ]; then
  # Check for unsafe C functions
  unsafe_found=""
  if echo "$cpp_files" | xargs grep -n 'strcpy\|strcat\|sprintf\|gets' 2>/dev/null; then
    unsafe_found="yes"
    echo -e "${RED}⚠ Warning: Unsafe C functions found (strcpy, strcat, sprintf, gets)${NC}"
  fi

  if [ -z "$unsafe_found" ]; then
    echo -e "${GREEN}✓ No obvious unsafe patterns found${NC}"
  fi
fi

# ============================================================================
# Check for secrets/credentials
# ============================================================================
echo -e "${YELLOW}Checking for potential secrets...${NC}"
if git diff --cached | grep -iE '(password|secret|api[_-]?key|token|credential|private[_-]?key)' | \
   grep -vE '(example|test|dummy|placeholder|<password>)' 2>/dev/null | head -5; then
  echo -e "${YELLOW}⚠ Warning: Potential secrets detected in commit${NC}"
  echo "Please review the above lines carefully."
  # Don't block, just warn
fi

# ============================================================================
# Verify binaries are not being committed
# ============================================================================
echo -e "${YELLOW}Checking for compiled binaries...${NC}"
binary_files=$(git diff --cached --name-only --diff-filter=ACM | \
  grep -E '^(src|ematch_src|knapsack_src)/' | \
  while read file; do
    if [ -f "$file" ] && file "$file" | grep -q "ELF.*executable"; then
      echo "$file"
    fi
  done)

if [ -n "$binary_files" ]; then
  echo -e "${RED}Error: Compiled binaries detected:${NC}"
  echo "$binary_files"
  echo "Please remove these from your commit."
  exit 1
fi

# ============================================================================
# Final success message
# ============================================================================
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}✓ All pre-commit checks passed!${NC}"
echo -e "${GREEN}========================================${NC}"

exit 0
